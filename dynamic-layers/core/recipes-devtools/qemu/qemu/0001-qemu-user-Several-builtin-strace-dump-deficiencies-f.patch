From 9dfc9f88d1e5749324c2899bc38f1245869153af Mon Sep 17 00:00:00 2001
From: Heinz Wrobel <Heinz.Wrobel@nxp.com>
Date: Tue, 5 Feb 2019 07:10:39 +0100
Subject: [PATCH 1/3] qemu-user: Several builtin strace dump deficiencies fixed

This could be considered cosmetic but was invaluable in debugging
other issues. A good number of syscalls was dumped in a confusing
way. And for execve, the output of any successful execution did
not even show at all.

Signed-off-by: Heinz Wrobel <Heinz.Wrobel@nxp.com>
---
 linux-user/strace.c    | 22 ++++++++++++++++++++--
 linux-user/strace.list | 18 +++++++++---------
 2 files changed, 29 insertions(+), 11 deletions(-)

diff --git a/linux-user/strace.c b/linux-user/strace.c
index cb636a6..d00ce36 100644
--- a/linux-user/strace.c
+++ b/linux-user/strace.c
@@ -670,7 +670,7 @@ print_execve(const struct syscallname *name,
         }
     }
 
-    gemu_log("NULL})");
+    gemu_log("NULL})...\n");
 }
 
 #ifdef TARGET_NR_ipc
@@ -1048,6 +1048,7 @@ print_file_mode(abi_long mode, int last)
 {
     const char *sep = "";
     const struct flags *m;
+    const abi_long origmode = mode;
 
     for (m = &mode_flags[0]; m->f_string != NULL; m++) {
         if ((m->f_value & mode) == m->f_value) {
@@ -1060,7 +1061,7 @@ print_file_mode(abi_long mode, int last)
 
     mode &= ~S_IFMT;
     /* print rest of the mode as octal */
-    if (mode != 0)
+    if (mode != 0 || !origmode)
         gemu_log("%s%#o", sep, (unsigned int)mode);
 
     gemu_log("%s", get_comma(last));
@@ -2472,6 +2473,23 @@ print_mmap(const struct syscallname *name,
 #define print_mmap2     print_mmap
 #endif
 
+#if defined(TARGET_NR_mremap)
+static void
+print_mremap(const struct syscallname *name,
+    abi_long arg0, abi_long arg1, abi_long arg2,
+    abi_long arg3, abi_long arg4, abi_long arg5)
+{
+    print_syscall_prologue(name);
+    print_pointer(arg0, 0);
+    print_raw_param("%d", arg1, 0);
+    print_pointer(arg2, 0);
+    print_raw_param("%d", arg3, 0);
+    print_raw_param("%d", arg4, 0);
+    print_raw_param("%#x", arg5, 1);
+    print_syscall_epilogue(name);
+}
+#endif
+
 #ifdef TARGET_NR_mprotect
 static void
 print_mprotect(const struct syscallname *name,
diff --git a/linux-user/strace.list b/linux-user/strace.list
index e6d95a1..058cde2 100644
--- a/linux-user/strace.list
+++ b/linux-user/strace.list
@@ -251,7 +251,7 @@
 { TARGET_NR_fstatfs64, "fstatfs64" , "%s(%d,%p)", NULL, NULL },
 #endif
 #ifdef TARGET_NR_fsync
-{ TARGET_NR_fsync, "fsync" , NULL, NULL, NULL },
+{ TARGET_NR_fsync, "fsync" , "%s(%d)", NULL, NULL },
 #endif
 #ifdef TARGET_NR_ftime
 { TARGET_NR_ftime, "ftime" , NULL, NULL, NULL },
@@ -287,22 +287,22 @@
 { TARGET_NR_getdtablesize, "getdtablesize" , NULL, NULL, NULL },
 #endif
 #ifdef TARGET_NR_getegid
-{ TARGET_NR_getegid, "getegid" , NULL, NULL, NULL },
+{ TARGET_NR_getegid, "getegid" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getegid32
-{ TARGET_NR_getegid32, "getegid32" , NULL, NULL, NULL },
+{ TARGET_NR_getegid32, "getegid32" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_geteuid
 { TARGET_NR_geteuid, "geteuid" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_geteuid32
-{ TARGET_NR_geteuid32, "geteuid32" , NULL, NULL, NULL },
+{ TARGET_NR_geteuid32, "geteuid32" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getgid
-{ TARGET_NR_getgid, "getgid" , NULL, NULL, NULL },
+{ TARGET_NR_getgid, "getgid" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getgid32
-{ TARGET_NR_getgid32, "getgid32" , NULL, NULL, NULL },
+{ TARGET_NR_getgid32, "getgid32" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getgroups
 { TARGET_NR_getgroups, "getgroups" , NULL, NULL, NULL },
@@ -393,7 +393,7 @@
 { TARGET_NR_getuid, "getuid" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getuid32
-{ TARGET_NR_getuid32, "getuid32" , NULL, NULL, NULL },
+{ TARGET_NR_getuid32, "getuid32" , "%s()", NULL, NULL },
 #endif
 #ifdef TARGET_NR_getxattr
 { TARGET_NR_getxattr, "getxattr" , NULL, NULL, NULL },
@@ -612,7 +612,7 @@
 { TARGET_NR_mq_unlink, "mq_unlink" , NULL, print_mq_unlink, NULL },
 #endif
 #ifdef TARGET_NR_mremap
-{ TARGET_NR_mremap, "mremap" , NULL, NULL, NULL },
+{ TARGET_NR_mremap, "mremap" , NULL, print_mremap, print_syscall_ret_addr },
 #endif
 #ifdef TARGET_NR_msgctl
 { TARGET_NR_msgctl, "msgctl" , NULL, NULL, NULL },
@@ -1657,7 +1657,7 @@
 { TARGET_NR_sync_file_range2, "sync_file_range2", NULL, NULL, NULL },
 #endif
 #ifdef TARGET_NR_pipe2
-{ TARGET_NR_pipe2, "pipe2", NULL, NULL, NULL },
+{ TARGET_NR_pipe2, "pipe2", "%s(%#x)", NULL, NULL },
 #endif
 #ifdef TARGET_NR_atomic_cmpxchg_32
 { TARGET_NR_atomic_cmpxchg_32, "atomic_cmpxchg_32", NULL, NULL, NULL },
-- 
1.8.3.1

